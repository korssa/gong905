import { NextRequest, NextResponse } from 'next/server';
import { list } from '@vercel/blob';

export async function GET(
  request: NextRequest,
  { params }: { params: { type: string } }
) {
  try {
    const { type } = params;
    
    // ìœ íš¨í•œ ê°¤ëŸ¬ë¦¬ íƒ€ì…ì¸ì§€ í™•ì¸
    if (!['a', 'b', 'c'].includes(type)) {
      return NextResponse.json(
        { success: false, error: 'Invalid gallery type' },
        { status: 400 }
      );
    }

    console.log(`ğŸ“ ê°¤ëŸ¬ë¦¬ ${type} ë°ì´í„° ë¡œë“œ ì‹œì‘...`);

    // í•´ë‹¹ ê°¤ëŸ¬ë¦¬ í´ë”ì˜ íŒŒì¼ë“¤ ì¡°íšŒ
    const { blobs } = await list({
      prefix: `gallery-${type}/`,
      limit: 1000
    });

    // meta.json íŒŒì¼ ì°¾ê¸°
    const metaFile = blobs.find(blob => blob.pathname === `gallery-${type}/meta.json`);
    
    if (metaFile) {
      // meta.jsonì—ì„œ ë°ì´í„° ë¡œë“œ
      const response = await fetch(metaFile.url);
      if (response.ok) {
        const data = await response.json();
        console.log(`âœ… ê°¤ëŸ¬ë¦¬ ${type} ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ${data.items?.length || 0}ê°œ í•­ëª©`);
        
        return NextResponse.json({
          success: true,
          data: data.items || [],
          count: data.items?.length || 0,
          type,
          lastUpdated: data.lastUpdated
        });
      }
    }

    // meta.jsonì´ ì—†ìœ¼ë©´ ì´ë¯¸ì§€ íŒŒì¼ë“¤ë¡œë¶€í„° ìë™ ìƒì„±
    const imageFiles = blobs.filter(blob => 
      blob.pathname.match(/\.(jpg|jpeg|png|gif|webp)$/i)
    );

    const items = imageFiles.map((file, index) => ({
      id: `gallery-${type}-${index + 1}`,
      imageUrl: file.url,
      title: `ì´ë¯¸ì§€ ${index + 1}`,
      author: 'ê³µëª…',
      likes: 0,
      views: 0,
      uploadDate: new Date().toISOString().split('T')[0],
      tags: []
    }));

    console.log(`âœ… ê°¤ëŸ¬ë¦¬ ${type} ìë™ ìƒì„± ì™„ë£Œ: ${items.length}ê°œ í•­ëª©`);

    return NextResponse.json({
      success: true,
      data: items,
      count: items.length,
      type,
      autoGenerated: true
    });

  } catch (error) {
    console.error(`âŒ ê°¤ëŸ¬ë¦¬ ${type} ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:`, error);
    return NextResponse.json(
      { 
        success: false, 
        error: error instanceof Error ? error.message : 'Unknown error',
        data: []
      },
      { status: 500 }
    );
  }
}
